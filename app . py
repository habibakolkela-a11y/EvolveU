import streamlit as st
import pandas as pd
import datetime
import matplotlib.pyplot as plt
import os

CSV_FILE = "behavior_data.csv"

situations = [
    {"q": "زميلك في العمل أخطأ في مهمة، ماذا تفعل؟",
     "options": ["أعاتبه أمام الجميع", "أنصحه بهدوء على انفراد"],
     "answer": "أنصحه بهدوء على انفراد"},
    {"q": "رأيت مسناً يحتاج مساعدة لعبور الطريق، ماذا تفعل؟",
     "options": ["أتجاهله", "أساعده"],
     "answer": "أساعده"},
]

daily_questions = [
    "هل التزمت بالمواعيد اليوم؟",
    "هل تجنبت رفع صوتك عند النقاش؟",
    "هل ساعدت أحد المحتاجين اليوم؟",
    "هل التزمت بقوانين المرور؟"
]

st.title("🌟 تطبيق سلوكياتي 🌟")
st.write("اختبر سلوكياتك اليومية وراقب تقدمك مع الوقت!")

if "score_situations" not in st.session_state:
    st.session_state.score_situations = 0
if "s_index" not in st.session_state:
    st.session_state.s_index = 0
if "score_daily" not in st.session_state:
    st.session_state.score_daily = 0
if "d_index" not in st.session_state:
    st.session_state.d_index = 0

# القسم الأول
st.header("1️⃣ اختبار المواقف")
if st.session_state.s_index < len(situations):
    q = situations[st.session_state.s_index]
    st.subheader(q["q"])
    choice = st.radio("اختر إجابة:", q["options"])
    if st.button("تأكيد الموقف"):
        if choice == q["answer"]:
            st.success("✅ إجابة صحيحة! أحسنت 👏")
            st.session_state.score_situations += 1
        else:
            st.error(f"❌ خطأ! الصحيح هو: {q['answer']}")
        st.session_state.s_index += 1
else:
    st.success(f"اختبار المواقف انتهى! نقاطك: {st.session_state.score_situations}/{len(situations)}")

# القسم الثاني
st.header("2️⃣ تقييم السلوك اليومي")
if st.session_state.d_index < len(daily_questions):
    dq = daily_questions[st.session_state.d_index]
    st.subheader(dq)
    choice = st.radio("اختر:", ["نعم", "لا"])
    if st.button("تأكيد السلوك اليومي"):
        if choice == "نعم":
            st.session_state.score_daily += 1
        st.session_state.d_index += 1
else:
    st.success(f"تقييم السلوك اليومي انتهى! نقاطك: {st.session_state.score_daily}/{len(daily_questions)}")

    if st.session_state.score_daily == len(daily_questions):
        st.balloons()
        st.write("👑 ممتاز! أنت قدوة في المجتمع 👌")
    elif st.session_state.score_daily >= 2:
        st.write("🙂 جيد! لكن يمكنك أن تتحسن أكثر")
    else:
        st.write("⚠️ تحتاج لمراجعة سلوكياتك اليومية")

    # حفظ النتائج
    today = datetime.date.today()
    data_row = {
        "date": today,
        "situations_score": st.session_state.score_situations,
        "daily_score": st.session_state.score_daily
    }

    if os.path.exists(CSV_FILE):
        df = pd.read_csv(CSV_FILE)
        df = pd.concat([df, pd.DataFrame([data_row])], ignore_index=True)
    else:
        df = pd.DataFrame([data_row])
    df.to_csv(CSV_FILE, index=False)

    # رسم بياني
    st.header("📊 تقدمك")
    df["date"] = pd.to_datetime(df["date"])
    plt.figure(figsize=(8,4))
    plt.plot(df["date"], df["situations_score"], marker='o', label="اختبار المواقف")
    plt.plot(df["date"], df["daily_score"], marker='o', label="السلوك اليومي")
    plt.xlabel("التاريخ")
    plt.ylabel("النقاط")
    plt.title("تقدمك اليومي")
    plt.legend()
    plt.xticks(rotation=45)
    st.pyplot(plt)
