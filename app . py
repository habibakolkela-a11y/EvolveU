import streamlit as st
import pandas as pd
import datetime
import matplotlib.pyplot as plt
import os

CSV_FILE = "behavior_data.csv"

situations = [
    {"q": "Ø²Ù…ÙŠÙ„Ùƒ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ Ø£Ø®Ø·Ø£ ÙÙŠ Ù…Ù‡Ù…Ø©ØŒ Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ",
     "options": ["Ø£Ø¹Ø§ØªØ¨Ù‡ Ø£Ù…Ø§Ù… Ø§Ù„Ø¬Ù…ÙŠØ¹", "Ø£Ù†ØµØ­Ù‡ Ø¨Ù‡Ø¯ÙˆØ¡ Ø¹Ù„Ù‰ Ø§Ù†ÙØ±Ø§Ø¯"],
     "answer": "Ø£Ù†ØµØ­Ù‡ Ø¨Ù‡Ø¯ÙˆØ¡ Ø¹Ù„Ù‰ Ø§Ù†ÙØ±Ø§Ø¯"},
    {"q": "Ø±Ø£ÙŠØª Ù…Ø³Ù†Ø§Ù‹ ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø¨ÙˆØ± Ø§Ù„Ø·Ø±ÙŠÙ‚ØŒ Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ",
     "options": ["Ø£ØªØ¬Ø§Ù‡Ù„Ù‡", "Ø£Ø³Ø§Ø¹Ø¯Ù‡"],
     "answer": "Ø£Ø³Ø§Ø¹Ø¯Ù‡"},
]

daily_questions = [
    "Ù‡Ù„ Ø§Ù„ØªØ²Ù…Øª Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ØŸ",
    "Ù‡Ù„ ØªØ¬Ù†Ø¨Øª Ø±ÙØ¹ ØµÙˆØªÙƒ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø´ØŸ",
    "Ù‡Ù„ Ø³Ø§Ø¹Ø¯Øª Ø£Ø­Ø¯ Ø§Ù„Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ØŸ",
    "Ù‡Ù„ Ø§Ù„ØªØ²Ù…Øª Ø¨Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø±ÙˆØ±ØŸ"
]

st.title("ğŸŒŸ ØªØ·Ø¨ÙŠÙ‚ Ø³Ù„ÙˆÙƒÙŠØ§ØªÙŠ ğŸŒŸ")
st.write("Ø§Ø®ØªØ¨Ø± Ø³Ù„ÙˆÙƒÙŠØ§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØ±Ø§Ù‚Ø¨ ØªÙ‚Ø¯Ù…Ùƒ Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª!")

if "score_situations" not in st.session_state:
    st.session_state.score_situations = 0
if "s_index" not in st.session_state:
    st.session_state.s_index = 0
if "score_daily" not in st.session_state:
    st.session_state.score_daily = 0
if "d_index" not in st.session_state:
    st.session_state.d_index = 0

# Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„
st.header("1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ù")
if st.session_state.s_index < len(situations):
    q = situations[st.session_state.s_index]
    st.subheader(q["q"])
    choice = st.radio("Ø§Ø®ØªØ± Ø¥Ø¬Ø§Ø¨Ø©:", q["options"])
    if st.button("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ù"):
        if choice == q["answer"]:
            st.success("âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø£Ø­Ø³Ù†Øª ğŸ‘")
            st.session_state.score_situations += 1
        else:
            st.error(f"âŒ Ø®Ø·Ø£! Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ: {q['answer']}")
        st.session_state.s_index += 1
else:
    st.success(f"Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù†ØªÙ‡Ù‰! Ù†Ù‚Ø§Ø·Ùƒ: {st.session_state.score_situations}/{len(situations)}")

# Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ
st.header("2ï¸âƒ£ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ")
if st.session_state.d_index < len(daily_questions):
    dq = daily_questions[st.session_state.d_index]
    st.subheader(dq)
    choice = st.radio("Ø§Ø®ØªØ±:", ["Ù†Ø¹Ù…", "Ù„Ø§"])
    if st.button("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ"):
        if choice == "Ù†Ø¹Ù…":
            st.session_state.score_daily += 1
        st.session_state.d_index += 1
else:
    st.success(f"ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù†ØªÙ‡Ù‰! Ù†Ù‚Ø§Ø·Ùƒ: {st.session_state.score_daily}/{len(daily_questions)}")

    if st.session_state.score_daily == len(daily_questions):
        st.balloons()
        st.write("ğŸ‘‘ Ù…Ù…ØªØ§Ø²! Ø£Ù†Øª Ù‚Ø¯ÙˆØ© ÙÙŠ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ ğŸ‘Œ")
    elif st.session_state.score_daily >= 2:
        st.write("ğŸ™‚ Ø¬ÙŠØ¯! Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªØªØ­Ø³Ù† Ø£ÙƒØ«Ø±")
    else:
        st.write("âš ï¸ ØªØ­ØªØ§Ø¬ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ù„ÙˆÙƒÙŠØ§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©")

    # Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    today = datetime.date.today()
    data_row = {
        "date": today,
        "situations_score": st.session_state.score_situations,
        "daily_score": st.session_state.score_daily
    }

    if os.path.exists(CSV_FILE):
        df = pd.read_csv(CSV_FILE)
        df = pd.concat([df, pd.DataFrame([data_row])], ignore_index=True)
    else:
        df = pd.DataFrame([data_row])
    df.to_csv(CSV_FILE, index=False)

    # Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ
    st.header("ğŸ“Š ØªÙ‚Ø¯Ù…Ùƒ")
    df["date"] = pd.to_datetime(df["date"])
    plt.figure(figsize=(8,4))
    plt.plot(df["date"], df["situations_score"], marker='o', label="Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ù")
    plt.plot(df["date"], df["daily_score"], marker='o', label="Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ")
    plt.xlabel("Ø§Ù„ØªØ§Ø±ÙŠØ®")
    plt.ylabel("Ø§Ù„Ù†Ù‚Ø§Ø·")
    plt.title("ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ")
    plt.legend()
    plt.xticks(rotation=45)
    st.pyplot(plt)
